# Телеграм бот на [grammY](https://grammy.dev) для [Deno Deploy](https://deno.com/deploy)

Бот предназначен для взаимодействия с системой лояльности GetMeBack:

-  **Поиск клиентов по номеру телефона** — выводит карту, имя, баланс и средний чек
-  **Регистрация новых клиентов** — регистрация новых клиентов в системе
-  **Поиск менеджеров** — работает через inline-запросы с выводом статистики
-  **Сохранение избранного менеджера** — сохранение избранного менеджера

## Настройка

1. Создайте проект на [Deno Deploy](https://deno.com/deploy).
2. Добавьте в настройки проекта следующие переменные окружения:
   - `BOT_TOKEN` - токен бота из @BotFather
   - `API_KEY` - ключ доступа к API
   - `API_BASE_URL` - основной адрес API (например, https://company.getmeback.ru)
   - `API_ENDPOINT_USERS` - путь для получения данных пользователей
   - `API_ENDPOINT_REGISTER` - путь для регистрации пользователей
   - `WEBHOOK_BASE_URL` - адрес вашего проекта на Deno Deploy
   - `DENO_ENV` - режим работы (production или development)
   - `DEBUG` - режим отладки (true или false)

3. Настройте вебхук для бота по шаблону:

```text
https://api.telegram.org/bot<BOT_TOKEN>/setWebhook?url=https://<ИМЯ_ПРОЕКТА>.deno.dev/<BOT_TOKEN>
```

### Публикация через GitHub

4. Загрузите код в репозиторий GitHub
5. В настройках проекта подключите GitHub и укажите `src/server.ts` как основной файл
6. Готово! Теперь при каждом push код будет автоматически обновляться

### Публикация через `deployctl`

4. Установите [`deployctl`](https://github.com/denoland/deployctl)
5. Получите [токен доступа](https://dash.deno.com/account#access-tokens)
6. Опубликуйте командой:
   `deployctl deploy --project <ИМЯ_ПРОЕКТА> ./src/server.ts --prod --token <ТОКЕН>`

## Разработка

Для локальной разработки используйте:

```bash
# Запуск с автоперезагрузкой при изменении кода
deno task dev

# Проверка типов
deno task check

# Полный запуск в режиме разработки
deno run --allow-net --allow-env --allow-read --allow-write --watch --env-file=.env src/poll.ts
```

Учтите, что режим разработки отключит вебхук, поэтому после загрузки на сервер нужно будет заново выполнить шаг 3.

## Безопасность

Не храните реальные значения переменных окружения в репозитории. Используйте файл `.env.example` как шаблон для настройки.